<!doctype html>
<html lang="en" >
<head>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta name="renderer" content="webkit|blink"/>
    <meta name="force-rendering" content="webkit|blink"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
    <link rel="stylesheet" href="dist/oldist/openlayers/ol.css" type="text/css">
    <link rel="stylesheet" href="dist/jquery-ui-1.11.4/jquery-ui.css" type="text/css">
    <style>
        html,body{
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #mapTitleBox{
            position:absolute;
            left: 50%;
            transform: translate(-50%);
            z-index: 1;   /*用于调整压盖顺序*/
        }
        #map {
            clear: both;
            position: relative;
            height: 100%;
            width: 100%;
            /*border: 1px solid rgb(78, 78, 78);*/
        }
        #loaction{
            position: absolute;
            left: 90%;
            z-index: 1;
        }
        #searchBar {
            position:absolute;
            left: 50%;
            transform: translate(-50%);
            z-index: 1;   /*用于调整压盖顺序*/
            text-align: center;
            vertical-align: -2px;
        }

        #searchBar input{
            border: 2px solid #c5464a;
            border-radius: 10px 3px 3px 10px;
            background: transparent;
            outline: none;
            vertical-align: 2px;
            
        }
        #searchBar button{
            border: none;
            background: #c5464a;
            border-radius: 0 20px 20px 0;
            width: 60px;
            top:0;
            right: 0;
            outline: none;
            cursor: pointer;/*设置鼠标箭头手势*/

        }
        #searchBar button:before{
            content: "搜索";
            font-family: FontAwesome;
            font-size: 16px;
            color: #f9f0da;
        }
        #searchBar button:hover{
            background-color: antiquewhite;
        }
        /*自动补全loading*/
        .ui-autocomplete-loading {
            background: white url('dist/jquery-ui-1.11.4/images/ui-anim_basic_16x16.gif') right center no-repeat;
        }
        /*
        #btn{

            width: auto;
            height: 50px;
            color:white;
            background-color:cornflowerblue;
            border-radius: 3px; /*让按钮变得圆滑一点*/
        /*
            border-width: 0; /*消去丑陋边框*/
        /*
            margin: 0;
            outline: none;/*取消轮廓*/
        /*
            font-size: 25px;
            font-family:KaiTi;
            text-align: center;/*字体居中*/
        /*
            cursor: pointer;/*设置鼠标箭头手势*/
        /*
        }
        #btn:hover{
            background-color: antiquewhite;
        }
        */

    </style>
    <script type="text/javascript" src="dist/oldist/openlayers/ol.js"></script>
    <script type="text/javascript" src="dist/jquery1.6.4/jquery.js"></script>
    <script type="text/javascript" src="dist/jquery-ui-1.11.4/jquery-ui.js"></script>
    <!--
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.6.4/jquery.js"></script>
    -->

    <title>xjs olmap</title>
</head>
<body>
    <div id="loadgif" style="position:absolute;top:45%;left:45%;z-index: 1">
        　　<img alt="加载中..." src="img/loading2.gif"/>
    </div>
    <div id = searchBar >
        <form id="formSearch"  action="/xjs/getGeoJson">      <!--action="getGeoJson"   不需要action-->
            <input type="text" id="searchTxt" name="searchTxt" placeholder="输入城市名">
                <!--onblur="if(this.value == '') this.value='在此输入您要查找的内容，点击搜索';"-->
            <button type="button" id="btn" value="点击这里查找数据库数据"></button>
        </form>

    </div>
    <div id="map" class="map" ></div>
    <div id="wrapper">
        <div id="location"></div>
    </div>

    <script type="text/javascript" src="js/initMap.js"></script>
    <script type="text/javascript">
        //函数入口
        $(function () {
            $("#loadgif").hide();  //隐藏loading动画
            initMap();
        })

        //按钮单击事件
        $('#btn').click(function() {
            $("#loadgif").show();
            //console.log($('#form2').serialize());  为什么这个函数得不到数据
            //获取表单对话框内容
            var searchTxtValue = $('#searchTxt').val();   //val()而不是value()
            console.log(searchTxtValue);

            $.ajax({  //AJAX向Servlet发送get请求，请求后台数据库数据
                url: "getGeoJson", // url不带/就是当前路径（因为我这个html放在webapp目录下），而且在页面上访问时已经包含application context，相当于/xjs/getGeoJson
                dataTpye: "json",   //传输json
                data:  {searchTxt:searchTxtValue},   //$('#form2').serialize(),  //按键值对形式
                type: "get",
                success: function (dbGeoJson) {  //回调函数，更新map
                    console.log(dbGeoJson);  //这里已经传回一个json对象
                    //var parsedJson = jQuery.parseJSON(msg);
                    //var parsedJson = eval('('+msg+')');
                    //console.log(parsedJson);
                    $("#loadgif").hide();
                    //添加到到图层
                    //dbVecLayer.source.addFeature((new ol.format.GeoJSON()).readFeatures(dbGeoJson));

                    var dbVecLayer = new ol.layer.Vector({
                        title: 'db vevtor Layer',
                        source: new ol.source.Vector({
                            projection: 'EPSG:4326',
                            features: (new ol.format.GeoJSON()).readFeatures(dbGeoJson)
                        })
                    });
                    map.addLayer(dbVecLayer);
                },
                error: function () {  //请求失败的回调方法
                    $("#loadgif").hide();
                    alert("请求失败，请重试");
                }
            });
        });

        //jquery-ui自动补全
        var autoCompleteUrl = "autoComplete";
        $("#searchTxt").autocomplete({
            source: function (request,response) {
                $.ajax({
                    url:autoCompleteUrl,
                    dataType:"json",
                    type:"get",    //get请求
                    data: {
                        searchTxt: request.term    //request.term传递当前参数
                    },
                    minLength:1,
                    success:function (result) {
                        response(result);
                    }
                })
            }

        })


    </script>
</body>
</html>

