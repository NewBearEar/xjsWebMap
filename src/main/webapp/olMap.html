<!doctype html>
<html lang="en" >
<head>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta name="renderer" content="webkit|blink"/>
    <meta name="force-rendering" content="webkit|blink"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
    <link rel="stylesheet" href="dist/oldist/openlayers/ol.css" type="text/css">
    <style>
        html,body{
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #mapTitleBox{
            position:absolute;
            left: 50%;
            transform: translate(-50%);
            z-index: 1;   /*用于调整压盖顺序*/
        }
        #map {
            clear: both;
            position: relative;
            height: 100%;
            width: 100%;
            /*border: 1px solid rgb(78, 78, 78);*/
        }
        #loaction{
            position: absolute;
            left: 90%;
            z-index: 1;
        }

        #btn{

            width: auto;
            height: 50px;
            color:white;
            background-color:cornflowerblue;
            border-radius: 3px;/*让按钮变得圆滑一点*/
            border-width: 0;/*消去丑陋边框*/
            margin: 0;
            outline: none;/*取消轮廓*/
            font-size: 25px;
            font-family:KaiTi;
            text-align: center;/*字体居中*/
            cursor: pointer;/*设置鼠标箭头手势*/
        }
        #btn:hover{
            background-color: antiquewhite;
        }


    </style>
    <script type="text/javascript" src="dist/oldist/openlayers/ol.js"></script>
    <script type="text/javascript" src="dist/jquery1.6.4/jquery.js"></script>
    <!--
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.6.4/jquery.js"></script>
    -->

    <title>xjs olmap</title>
</head>
<body>
    <div id="loadgif" style="position:absolute;top:45%;left:45%;z-index: 1">
        　　<img alt="加载中..." src="img/loading2.gif"/>
    </div>
    <div id = mapTitleBox >
        <form id="formSearch"  action="/xjs/getGeoJson">      <!--action="getGeoJson"   不需要action-->
            <input type="text" id="searchTxt" name="searchTxt" placeholder="输入城市名">
                   <!--onblur="if(this.value == '') this.value='在此输入您要查找的内容，点击搜索';"-->
            <div style="text-align: center;">
                <input type="button" id="btn" value="点击这里查找数据库数据"></input>
            </div>
        </form>

    </div>
    <div id="map" class="map" ></div>
    <div id="wrapper">
        <div id="location"></div>
    </div>


    <script type="text/javascript">
        //基本底图
        var envstr = '';
        var extent = [73.44696044921875,6.318641185760498,135.08583068847656,53.557926177978516];

        var urlAdr = 'http://47.94.150.127:8080/geoserver/xjs/wms';   //8080是Tomcat9那个服务器，需要在云端运行tomcat9
        //var layerName = 'xjs:BoundaryChn2_4p,xjs:BoundaryChn2_4l,xjs:BoundaryChn1_4l';
        var layerName = 'xjs:BoundaryChn2_4p,xjs:BoundaryChn2_4l,xjs:BoundaryChn1_4l';
        var tiled;   //Tile WMS
        var untiled;   //WMS服务
        var provinceAnotation; //省注记
        var dbVecLayer;  //查询图层
        var map; //地图
        var dbSourceVec;   //数据库矢量数据源
        var init = function(){
            //设置地图范围

            var mlayers = initLayers();
            //定义地图对象//地图对象
            map = new ol.Map({

                layers: mlayers,
                target: 'map',
                view: new ol.View({
                    projection: 'EPSG:4326',
                    //center: [115, 39],
                    //zoom: 4
                }),
                controls: ol.control.defaults({
                    attributionOptions: {
                        collapsible: true
                    }
                })

            });
            initOlTools(); //初始化工具

        }

        //初始化所有图层，返回图层数组
        var initLayers = function (){
            //OSM图像图层
            osmtile =  new ol.layer.Tile({
                visible:true,
                source: new ol.source.OSM({
                    maxZoom:4
                })
            });
            //瓦片图层
            tiled = new ol.layer.Tile({
                visible:true,
                source: new ol.source.TileWMS({
                    url: urlAdr,  //URL

                    params: {  //请求参数
                        'LAYERS': layerName,
                        'TILED': false,  //对TileWMS无影响
                        'env':'',   //ogc:function env动态设置地图颜色，空字符表示默认采用SLD文件配置的值
                    },
                    serverType: 'geoserver'
                })
            });

            //注记图层
            provinceAnotation = new ol.layer.Image({
                visible:true,
                source: new ol.source.ImageWMS({
                    ratio: 1,
                    url: urlAdr,
                    params: {
                        "LAYERS": 'xjs:ProvinceAnotation',
                        'TILED': false,
                    },
                    serverType: 'geoserver'
                })
            });

            //JSON图层
            var jsonUrl = "data/GeoJSON_HB.json" ;   //   "data/GeoJSON_HB.json";
            var testServletUrl = "getGeoJson";
            //Json读取
            var jsonVecLayer = new ol.layer.Vector({
                title: 'add Layer',
                source: new ol.source.Vector({
                    projection: 'EPSG:4326',
                    url:  testServletUrl, //jsonUrl, // testServletUrl,   //GeoJSON的文件路径
                    // 注意，当servlet正确输出时，这里也可以直接填写servlet的url，不需要利用(ajax)请求返回数据，再用readFeatures方法来加载json对象了
                    format: new ol.format.GeoJSON()
                })
            })

            /*
            //数据库查询图层
            dbVecLayer = new ol.layer.Vector({
                title: 'db vevtor Layer',
                source: new ol.source.Vector({
                    projection: 'EPSG:4326',

                })
            })*/

            var mlayers = [osmtile,tiled,jsonVecLayer,provinceAnotation];  //dbVecLayer];  //图层数组
            return mlayers;
        }



        var initOlTools = function(){
            //自适应地图view
            map.getView().fit(extent, map.getSize());
            //map.getView().setZoom(4);
            //添加比例尺控件
            map.addControl(new ol.control.ScaleLine());
            //添加缩放滑动控件
            map.addControl(new ol.control.ZoomSlider());
            //添加全屏控件
            map.addControl(new ol.control.FullScreen());
            //添加鼠标定位控件
            map.addControl(new ol.control.MousePosition({
                    undefinedHTML: 'outside',
                    projection: 'EPSG:4326',
                    target:$("#location")[0],
                    coordinateFormat: function(coordinate) {
                        return ol.coordinate.format(coordinate, '{x}, {y}', 4);
                    }
                })
            );
        }

        $('#btn').click(function() {
            $("#loadgif").show();
            //console.log($('#form2').serialize());  为什么这个函数得不到数据
            //获取表单对话框内容
            var searchTxtValue = $('#searchTxt').val();   //val()而不是value()
            console.log(searchTxtValue);

            $.ajax({  //AJAX向Servlet发送get请求，请求后台数据库数据
                url: "getGeoJson", // url不带/就是当前路径（因为我这个html放在webapp目录下），而且在页面上访问时已经包含application context，相当于/xjs/getGeoJson
                dataTpye: "json",   //传输json
                data:  {searchTxt:searchTxtValue},   //$('#form2').serialize(),  //按键值对形式
                type: "get",
                success: function (dbGeoJson) {  //回调函数，更新map
                    console.log(dbGeoJson);  //这里已经传回一个json对象
                    //var parsedJson = jQuery.parseJSON(msg);
                    //var parsedJson = eval('('+msg+')');
                    //console.log(parsedJson);
                    $("#loadgif").hide();
                    //添加到到图层
                    //dbVecLayer.source.addFeature((new ol.format.GeoJSON()).readFeatures(dbGeoJson));

                    var dbVecLayer = new ol.layer.Vector({
                        title: 'db vevtor Layer',
                        source: new ol.source.Vector({
                            projection: 'EPSG:4326',
                            features: (new ol.format.GeoJSON()).readFeatures(dbGeoJson)
                        })
                    });
                    map.addLayer(dbVecLayer);
                },
                error: function () {  //请求失败的回调方法
                    $("#loadgif").hide();
                    alert("请求失败，请重试");
                }
            });
        });


        //函数入口
        $(function () {
            $("#loadgif").hide();  //隐藏loading动画
            init();
        })

    </script>
</body>
</html>

