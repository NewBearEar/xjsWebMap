<!doctype html>
<html lang="en" >
<head>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8"/>
    <meta name="renderer" content="webkit|blink"/>
    <meta name="force-rendering" content="webkit|blink"/>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>

    <script type="text/javascript" src="dist/oldist/openlayers/ol.js"></script>
    <script type="text/javascript" src="dist/jquery/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="dist/jquery-ui-1.12.1/jquery-ui.js"></script>


    <!--js放在css文件前，防止css样式被js刷掉-->
    <!--链接式导入css-->
    <link rel="stylesheet" href="dist/oldist/openlayers/ol.css" type="text/css">
    <link rel="stylesheet" href="dist/jquery-ui-1.12.1/jquery-ui.css" type="text/css">
    <link rel="stylesheet" href="css/myMapStyle.css" type="text/css">
    <style>
        /*基于juery ui css
        /*自动补全loading*/
        .ui-autocomplete-loading {
            background: white url('dist/jquery-ui-1.11.4/images/ui-anim_basic_16x16.gif') right center no-repeat;
        }
        .ui-autocomplete{
            width: 290px;
            left: 50px;

            /*试试阴影效果*/
            filter: progid:DXImageTransform.Microsoft.shadow(color=#909090,direction=120,strength=2);
            -moz-box-shadow: 1px 1px 5px #909090;
            -webkit-box-shadow: 1px 1px 5px #909090;
            box-shadow: 1px 1px 5px #909090;
            border-color: rgb(200,200,200);
        }
        /*重写选中时的样式*/
        .ui-state-active:hover {
            border: 1px solid rgb(200,200,200);
            background: rgb(238,238,238);
            font-weight: normal;
            color: #000000;  /*字体颜色黑色不变*/

        }


    </style>

    <!--
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.6.4/jquery.js"></script>
    -->

    <title>xjs olmap</title>
</head>
<body>
    <div id="loadgif" style="position:absolute;top:45%;left:45%;z-index: 1">
        　　<img alt="加载中..." src="img/loading2.gif"/>
    </div>
    <div id="left-panel" class style="height: 807px">
        <div id = searchBar >
            <form id="formSearch"  action="/xjs/getGeoJson">      <!--action="getGeoJson"   不需要action-->
                <img src="img/searchimg.png" alt="">
                <input type="text" id="searchTxt" name="searchTxt" placeholder="输入搜索城市名" >
                    <!--onblur="if(this.value == '') this.value='在此输入您要查找的内容，点击搜索';"-->
                <button type="button" id="btn" value="搜索"></button>
            </form>
        </div>
    </div>
    <div id="map" class="map" ></div>
    <div id="wrapper">
        <div id="location"></div>
    </div>

    <script type="text/javascript" src="js/initMap.js"></script>
    <script type="text/javascript">
        //函数入口
        $(function () {
            $("#loadgif").hide();  //隐藏loading动画
            initMap();
        })

        //按钮单击事件
        $('#btn').click(function() {
            $("#loadgif").show();
            //console.log($('#form2').serialize());  为什么这个函数得不到数据
            //获取表单对话框内容
            var searchTxtValue = $('#searchTxt').val();   //val()而不是value()
            console.log(searchTxtValue);

            $.ajax({  //AJAX向Servlet发送get请求，请求后台数据库数据
                url: "getGeoJson", // url不带/就是当前路径（因为我这个html放在webapp目录下），而且在页面上访问时已经包含application context，相当于/xjs/getGeoJson
                dataType: "json",   //传输json
                data:  {searchTxt:searchTxtValue},   //$('#form2').serialize(),  //按键值对形式
                type: "get",
                success: function (dbGeoJson) {  //回调函数，更新map
                    console.log(dbGeoJson);  //这里已经传回一个json对象
                    //var parsedJson = jQuery.parseJSON(msg);
                    //var parsedJson = eval('('+msg+')');
                    //console.log(parsedJson);
                    $("#loadgif").hide();
                    //添加到到图层
                    //dbVecLayer.source.addFeature((new ol.format.GeoJSON()).readFeatures(dbGeoJson));

                    var dbVecLayer = new ol.layer.Vector({
                        title: 'db vevtor Layer',
                        source: new ol.source.Vector({
                            projection: 'EPSG:4326',
                            features: (new ol.format.GeoJSON()).readFeatures(dbGeoJson)
                        })
                    });
                    map.addLayer(dbVecLayer);
                },
                error: function () {  //请求失败的回调方法
                    $("#loadgif").hide();
                    alert("请求失败，请重试");
                }
            });
        });

        //jquery-ui自动补全
        var autoCompleteUrl = "autoComplete";
        $("#searchTxt").autocomplete({
            source: function (request,response) {
                $.ajax({
                    url:autoCompleteUrl,
                    dataType:"json",
                    type:"post",    //get请求
                    data: {
                        searchTxt: request.term    //request.term传递当前参数
                    },
                    minLength:1,
                    success:function (result) {
                        response(result);  //向页面相应
                    }
                })
            }

        })


    </script>
</body>
</html>

